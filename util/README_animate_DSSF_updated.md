# animate_DSSF_updated.py

## Overview

This script reads the processed spectral data output from `calc_QFI.py` and creates comprehensive visualizations including:
- Stacked plots showing spectral evolution across different beta values
- Heatmaps showing spectral function as a function of frequency and temperature
- Animations showing spectral evolution with temperature
- Comparison plots of different operators at the same temperature
- **Automatic combination of SF and NSF channels into DO (double-differential) channels**

## Key Features

### Automatic DO Channel Generation

The script automatically detects SF (spin-flip) and NSF (non-spin-flip) channel pairs and combines them into DO (double-differential) channels using:

```
DO = SF + NSF
```

This applies to:
- **Transverse operators**: `SpSm_q_Qx0_Qy0_Qz0_SF` + `SpSm_q_Qx0_Qy0_Qz0_NSF` → `SpSm_q_Qx0_Qy0_Qz0_DO`
- **Transverse experimental operators**: `TransverseExperimental_q_Qx0_Qy0_Qz0_theta0_SF` + `TransverseExperimental_q_Qx0_Qy0_Qz0_theta0_NSF` → `TransverseExperimental_q_Qx0_Qy0_Qz0_theta0_DO`

DO channels are plotted with dashed lines in comparison plots for easy identification.

### Example DO Combination

Given the following input files:
```
processed_data/
├── SpSm_q_Qx0_Qy0_Qz0_SF/
│   ├── spectral_beta_inf.dat
│   └── spectral_beta_1.0.dat
└── SpSm_q_Qx0_Qy0_Qz0_NSF/
    ├── spectral_beta_inf.dat
    └── spectral_beta_1.0.dat
```

The script will automatically create:
```
DO Combined Output:
└── SpSm_q_Qx0_Qy0_Qz0_DO/
    ├── SpSm_q_Qx0_Qy0_Qz0_DO_stacked.png
    ├── SpSm_q_Qx0_Qy0_Qz0_DO_heatmap.png
    └── SpSm_q_Qx0_Qy0_Qz0_DO_animation.gif
```

At each frequency point: `S_DO(ω) = S_SF(ω) + S_NSF(ω)`

## Input Structure

The script expects data in the structure created by `calc_QFI.py`:

```
structure_factor_results/
├── processed_data/
│   ├── SpSm_q_Qx0_Qy0_Qz0/
│   │   ├── spectral_beta_inf.dat
│   │   ├── spectral_beta_1.0.dat
│   │   ├── peaks_beta_inf.dat
│   │   └── peaks_beta_1.0.dat
│   ├── SzSz_q_Qx0_Qy0_Qz0/
│   │   └── ...
│   ├── SpSm_q_Qx0_Qy0_Qz0_sub0_sub1/  (sublattice-resolved)
│   │   └── ...
│   ├── SzSz_q_Qx0_Qy0_Qz0_SF/  (spin-flip channel)
│   │   └── ...
│   └── Experimental_q_Qx0_Qy0_Qz0_theta0/  (experimental geometry)
│       └── ...
```

## Species Naming Convention

Species names are generated by `TPQ_DSSF.cpp` and include:

### Standard Sum Operators (`operator_type="sum"`)
- Format: `{SpinOp}_q_Qx{x}_Qy{y}_Qz{z}`
- Examples:
  - `SpSm_q_Qx0_Qy0_Qz0` (S⁺S⁻ at Q=(0,0,0))
  - `SzSz_q_Qx0_Qy0_Qz6.28319` (SᶻSᶻ at Q=(0,0,2π))

### Sublattice-Resolved Operators (`operator_type="sublattice"`)
- Format: `{SpinOp}_q_Qx{x}_Qy{y}_Qz{z}_sub{i}_sub{j}`
- Examples:
  - `SpSm_q_Qx0_Qy0_Qz0_sub0_sub1` (S⁺S⁻ between sublattices 0 and 1)
  - `SzSz_q_Qx0_Qy0_Qz0_sub2_sub3` (SᶻSᶻ between sublattices 2 and 3)

### Transverse Operators (`operator_type="transverse"`)
- Format: `{SpinOp}_q_Qx{x}_Qy{y}_Qz{z}_{SF|NSF}`
- Examples:
  - `SpSm_q_Qx0_Qy0_Qz0_SF` (spin-flip channel)
  - `SzSz_q_Qx0_Qy0_Qz0_NSF` (non-spin-flip channel)

### Experimental Operators (`operator_type="experimental"`)
- Format: `Experimental_q_Qx{x}_Qy{y}_Qz{z}_theta{angle}`
- Examples:
  - `Experimental_q_Qx0_Qy0_Qz0_theta0` (θ=0 geometry)
  - `Experimental_q_Qx0_Qy0_Qz0_theta1.5708` (θ=π/2 geometry)

### Transverse Experimental Operators (`operator_type="transverse_experimental"`)
- Format: `TransverseExperimental_q_Qx{x}_Qy{y}_Qz{z}_theta{angle}_{SF|NSF}`
- Combines experimental geometry (cos(θ)Sz + sin(θ)Sx) with SF/NSF channel separation
- Examples:
  - `TransverseExperimental_q_Qx0_Qy0_Qz0_theta0_SF` (θ=0, spin-flip channel)
  - `TransverseExperimental_q_Qx0_Qy0_Qz0_theta1.5708_NSF` (θ=π/2, non-spin-flip channel)

## File Format

### Spectral Data Files (`spectral_beta_{beta}.dat`)
Three-column format:
```
# freq spectral_function_real spectral_function_imag
-3.0  0.123456  0.000001
-2.9  0.234567  0.000002
...
```

### Peak Data Files (`peaks_beta_{beta}.dat`)
Three-column format:
```
# freq height prominence
0.5   1.234   0.567
1.2   2.345   1.234
...
```

## Usage

### Basic Usage

```bash
python animate_DSSF_updated.py
```

### Configuration

Edit the configuration section at the top of the script:

```python
# Configuration
BASE_DIR = "/path/to/your/data"  # Directory containing structure_factor_results/
OUTPUT_DIR = os.path.join(BASE_DIR, "spectral_animations")

# Conversion factors (adjust for your system)
ENERGY_CONVERSION_FACTOR = 0.063  # Jzz in meV

# Frequency range limits (in Jzz units)
FREQ_MIN = -3.0
FREQ_MAX = 6.0
```

## Output Structure

The script creates organized output directories:

```
spectral_animations/
├── 0_summary/              # Summary plots
├── 1_individual_species/   # Individual species stacked plots
├── 2_combined_plots/       # Comparison plots at fixed beta
├── 3_beta_evolution/       # Animations showing beta evolution
└── 4_heatmaps/            # Heatmaps of spectral function
```

## Output Files

### 1. Stacked Plots
- File: `{species}_stacked.png`
- Shows spectral functions at all beta values with vertical offset
- Useful for quick overview of temperature evolution

### 2. Heatmaps
- File: `{species}_heatmap.png`
- Shows spectral function as a 2D color plot (frequency × beta)
- Highlights spectral weight redistribution with temperature

### 3. Animations
- File: `{species}_animation.gif`
- Animated evolution of spectral function with beta
- Includes peak markers (red X)
- Useful for presentations

### 4. Comparison Plots
- File: `comparison_beta_{beta}.png`
- Compares multiple operators at the same beta
- Only created for beta values present in all species
- DO channels are shown with dashed lines

### 5. DO Channel Plots
- Automatically generated for any SF/NSF pairs found
- Same plot types as individual species (stacked, heatmap, animation)
- File naming: `{operator}_q_Qx{x}_Qy{y}_Qz{z}_DO_*.png`

## Dependencies

```bash
pip install numpy matplotlib scipy
```

## Notes

1. **Beta = infinity**: The script handles infinite beta values specially, plotting them as β=100 in heatmaps

2. **Frequency Range**: Adjust `FREQ_MIN` and `FREQ_MAX` to focus on regions of interest

3. **LaTeX Labels**: Operator names are automatically converted to LaTeX format for better plot labels

4. **Missing Data**: The script gracefully handles missing data files and continues processing

5. **DO Channel Combination**: SF and NSF pairs are automatically detected and combined. The script verifies that frequency arrays match before combining and will skip pairs with incompatible data

6. **Peak Data**: When combining SF+NSF into DO, peak data from both channels are merged and sorted by frequency

## Integration with calc_QFI.py

Typical workflow:

```bash
# Step 1: Process raw time correlation data
python calc_QFI.py

# Step 2: Create visualizations
python animate_DSSF_updated.py
```

## Troubleshooting

### No species found
- Check that `BASE_DIR` points to the correct directory
- Ensure `calc_QFI.py` has been run successfully
- Verify that `structure_factor_results/processed_data/` exists

### Missing plots
- Check console output for error messages
- Verify that spectral data files exist for the species
- Ensure frequency range (`FREQ_MIN`, `FREQ_MAX`) is appropriate

### Animation too slow/fast
- Adjust the `interval` parameter in `FuncAnimation` (line ~415)
- Adjust the `fps` parameter in `PillowWriter` (line ~417)

## Advanced Customization

### Custom Color Schemes
Change the colormap in plotting functions:
```python
colors = cm.viridis(...)  # Change to: plasma, inferno, magma, etc.
```

### Plot Resolution
Adjust DPI in `savefig` calls:
```python
plt.savefig(output_file, dpi=300)  # Increase for higher resolution
```

### Heatmap Interpolation
Modify grid resolution in `create_heatmap_plot`:
```python
freq_grid = np.linspace(..., 200)  # Increase for smoother interpolation
beta_grid = np.linspace(..., 50)
```

## Related Scripts

- `calc_QFI.py`: Processes raw time correlation data and computes spectral functions
- `animate_DSSF_cartesian.py`: Creates Cartesian basis visualizations from spherical operators
- `TPQ_DSSF.cpp`: Generates the raw time correlation data

## Author & References

This script complements the exact diagonalization framework for computing dynamical structure factors in quantum spin systems. For theoretical background, see documentation of `TPQ_DSSF.cpp`.
